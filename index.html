<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro de Votantes</title>

  <!-- Bootstrap CSS + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body { background: #f7f8fb; }
    .card { border: 0; box-shadow: 0 10px 25px rgba(0,0,0,.05); }
    .required::after { content: " *"; color: #d63384; font-weight: 700; }
    .table thead th { white-space: nowrap; }
    .small-muted { font-size: .9rem; color:#6c757d }
    .cursor-pointer { cursor: pointer; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between gap-2 mb-3">
      <div class="d-flex align-items-center gap-2">
        <i class="bi bi-people-fill fs-3 text-primary"></i>
        <div>
          <h1 class="h3 m-0">Registro de Votantes</h1>
          <div class="small-muted">Campos: <strong>Nombre</strong>, <strong>Cédula</strong>, <strong>Teléfono</strong>, <strong>Municipio</strong>. (Conexión a API)</div>
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span id="admin-badge" class="badge text-bg-secondary">Modo visitante</span>
        <button id="btn-admin" class="btn btn-outline-dark btn-sm"><i class="bi bi-shield-lock"></i> Admin</button>
        <button id="btn-logout" class="btn btn-outline-secondary btn-sm d-none"><i class="bi bi-box-arrow-right"></i> Salir</button>
      </div>
    </div>

    <!-- FORM -->
    <div class="card mb-4">
      <div class="card-body">
        <form id="form" class="row g-3" novalidate>
          <input type="hidden" id="id" />
          <div class="col-md-3">
            <label class="form-label required" for="nombre">Nombre</label>
            <input class="form-control" id="nombre" placeholder="Ej. Ana Pérez" required />
            <div class="invalid-feedback">Ingresa un nombre válido (mín. 2 caracteres).</div>
          </div>
          <div class="col-md-3">
            <label class="form-label required" for="cedula">Cédula</label>
            <input class="form-control" id="cedula" inputmode="numeric" pattern="[0-9]{4,}" placeholder="Ej. 123456789" required />
            <div class="invalid-feedback" id="cedula-feedback">Ingresa una cédula válida (solo dígitos, mín. 4).</div>
          </div>
          <div class="col-md-3">
            <label class="form-label required" for="telefono">Teléfono</label>
            <input class="form-control" id="telefono" inputmode="tel" pattern="[0-9]{6,}" placeholder="Ej. 3001234567" required />
            <div class="invalid-feedback">Ingresa un teléfono válido (solo dígitos, mín. 6).</div>
          </div>
          <div class="col-md-3">
            <label class="form-label required" for="municipio">Municipio</label>
            <input class="form-control" id="municipio" placeholder="Ej. Pasto" required />
            <div class="invalid-feedback">Ingresa el municipio.</div>
          </div>
          <div class="col-12 d-flex gap-2">
            <button class="btn btn-primary" id="btn-guardar" type="submit"><i class="bi bi-save me-1"></i>Guardar</button>
            <button class="btn btn-secondary d-none" id="btn-cancelar" type="button"><i class="bi bi-x-circle me-1"></i>Cancelar edición</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ADMIN TOOLS -->
    <div id="admin-tools" class="row g-2 align-items-center mb-3 d-none">
      <div class="col-sm-8 small-muted">Herramientas de administrador</div>
      <div class="col-sm-4 text-sm-end d-flex gap-2 justify-content-sm-end">
        <button id="btn-export" class="btn btn-outline-success btn-sm"><i class="bi bi-download"></i> Exportar CSV</button>
        <button id="btn-wipe" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash3"></i> Eliminar todo</button>
      </div>
    </div>

    <!-- TOOLS -->
    <div class="row g-2 align-items-center mb-3">
      <div class="col-sm-6">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input id="q" class="form-control" placeholder="Buscar por nombre, cédula, teléfono o municipio" />
          <button id="btn-buscar" class="btn btn-outline-primary">Buscar</button>
          <button id="btn-limpiar" class="btn btn-outline-secondary">Limpiar</button>
        </div>
      </div>
      <div class="col-sm-6 text-sm-end small-muted">
        <span id="contador">0</span> registro(s)
      </div>
    </div>

    <!-- TABLE -->
    <div class="card">
      <div class="table-responsive">
        <table class="table table-striped align-middle m-0">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Nombre</th>
              <th>Cédula</th>
              <th>Teléfono</th>
              <th>Municipio</th>
              <th>Creado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Admin -->
  <div class="modal fade" id="adminModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-shield-lock"></i> Acceso administrador</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label class="form-label" for="admin-pass">Contraseña</label>
          <input id="admin-pass" type="password" class="form-control" placeholder="Ingresa la contraseña" />
          <div class="form-text">* La verificaremos contra el servidor.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="btn-admin-login" class="btn btn-primary">Ingresar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle con Popper (cárgalo ANTES de tu script) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>

  <!-- Tu script (inline) -->
  <script>
    // ===== CONFIG =====
    const API_BASE = 'https://registro-votantes-api-1.onrender.com'; // <-- tu URL backend

    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    let isAdmin = false;
    let token = sessionStorage.getItem('rv:token') || '';

    // ===== HELPERS API =====
    async function api(path, { method = 'GET', body, auth = false } = {}){
      const headers = { 'Content-Type': 'application/json' };
      if (auth && token) headers['Authorization'] = `Bearer ${token}`;
      const res = await fetch(`${API_BASE}${path}`, { method, headers, body: body ? JSON.stringify(body) : undefined });
      if (!res.ok) {
        let errText = 'Error';
        try { const j = await res.json(); errText = j.error || (j.errors && j.errors.join(', ')) || errText; } catch {}
        throw new Error(errText);
      }
      return res.json();
    }

    // Endpoints  (FIX: backtick extra eliminado)
    const apiList   = (q='') => api(`/api/voters${q ? `?q=${encodeURIComponent(q)}` : ''}`);
    const apiExists = (cedula) => api(`/api/voters/exists?cedula=${encodeURIComponent(cedula)}`);
    const apiCreate = (payload) => api('/api/voters', { method:'POST', body: payload });
    const apiUpdate = (id, payload) => api(`/api/voters/${id}`, { method:'PUT', body: payload, auth: true });
    const apiDelete = (id) => api(`/api/voters/${id}`, { method:'DELETE', auth: true });
    const apiLogin  = (password) => api('/api/auth/login', { method:'POST', body:{ password } });

    // ===== STATE =====
    const state = { items: [], filter: '' };

    const fmtDT  = (iso) => new Date(iso).toLocaleString();
    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#039;");
    }

    async function loadAndRender(){
      const q = $('#q').value.trim();
      state.items = await apiList(q);
      render();
    }

    function render(){
      const tbody = $('#tbody');
      tbody.innerHTML = '';
      $('#contador').textContent = state.items.length;
      state.items.forEach((v, idx) => {
        const tel = v.telefono;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${escapeHtml(v.nombre)}</td>
          <td>${escapeHtml(v.cedula)}</td>
          <td>${escapeHtml(tel)}</td>
          <td>${escapeHtml(v.municipio)}</td>
          <td>${fmtDT(v.created_at)}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" data-action="edit" data-id="${v.id}" ${isAdmin?'':'disabled'}><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-danger" data-action="del" data-id="${v.id}" ${isAdmin?'':'disabled'}><i class="bi bi-trash"></i></button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function clearForm(){
      $('#id').value = '';
      $('#form').reset();
      $('#btn-cancelar').classList.add('d-none');
      $$('#form .is-invalid').forEach(el=>el.classList.remove('is-invalid'));
      $('#cedula').classList.remove('is-invalid');
      $('#cedula-feedback').textContent = 'Ingresa una cédula válida (solo dígitos, mín. 4).';
    }

    // Submit (create/update)
    $('#form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const nombre = $('#nombre').value.trim();
      const cedula = $('#cedula').value.trim();
      const telefono = $('#telefono').value.trim();
      const municipio = $('#municipio').value.trim();
      if (nombre.length < 2 || !/^[0-9]{4,}$/.test(cedula) || !/^[0-9]{6,}$/.test(telefono) || municipio.length < 2){
        $$('#form input').forEach(inp => { inp.classList.toggle('is-invalid', !inp.checkValidity()); });
        return;
      }
      const id = $('#id').value;
      try {
        if (id) {
          await apiUpdate(id, { nombre, cedula, telefono, municipio });
        } else {
          await apiCreate({ nombre, cedula, telefono, municipio });
        }
        clearForm();
        await loadAndRender();
      } catch(err){
        if (String(err.message).toLowerCase().includes('cédula')){
          $('#cedula').classList.add('is-invalid');
          $('#cedula-feedback').textContent = err.message;
        } else {
          alert(err.message);
        }
      }
    });

    // Edit / Delete
    $('#tbody').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      const v = state.items.find(x => String(x.id) === String(id));
      if (!v) return;
      if (action === 'edit'){
        $('#id').value = v.id;
        $('#nombre').value = v.nombre;
        $('#cedula').value = v.cedula;
        $('#telefono').value = v.telefono;
        $('#municipio').value = v.municipio;
        $('#btn-cancelar').classList.remove('d-none');
        scrollTo({ top: 0, behavior: 'smooth' });
      } else if (action === 'del'){
        if (confirm('¿Eliminar este registro?')){
          try { await apiDelete(id); await loadAndRender(); }
          catch(err){ alert(err.message); }
        }
      }
    });

    // Cancelar edición
    $('#btn-cancelar').addEventListener('click', clearForm);

    // Buscar
    $('#btn-buscar').addEventListener('click', loadAndRender);
    $('#btn-limpiar').addEventListener('click', ()=>{ $('#q').value=''; loadAndRender(); });
    $('#q').addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); loadAndRender(); } });

    // Blur cédula (server check)
    $('#cedula').addEventListener('blur', async ()=>{
      const ced = $('#cedula').value.trim();
      if (!ced) return;
      try {
        const { exists } = await apiExists(ced);
        if (exists){
          $('#cedula').classList.add('is-invalid');
          $('#cedula-feedback').textContent = 'Esta cédula ya está registrada.';
        } else {
          $('#cedula').classList.remove('is-invalid');
          $('#cedula-feedback').textContent = 'Ingresa una cédula válida (solo dígitos, mín. 4).';
        }
      } catch {}
    });

    // ===== Admin =====
    const adminModal = new bootstrap.Modal('#adminModal');
    function setAdmin(on){
      isAdmin = !!on;
      $('#admin-badge').textContent = on ? 'Admin activo' : 'Modo visitante';
      $('#admin-badge').className = on ? 'badge text-bg-success' : 'badge text-bg-secondary';
      $('#admin-tools').classList.toggle('d-none', !on);
      $('#btn-admin').classList.toggle('d-none', on);
      $('#btn-logout').classList.toggle('d-none', !on);
      render();
    }

    $('#btn-admin').addEventListener('click', ()=>{ $('#admin-pass').value=''; adminModal.show(); });
    $('#btn-admin-login').addEventListener('click', async ()=>{
      const password = $('#admin-pass').value;
      try {
        const { token: t } = await apiLogin(password);
        token = t; sessionStorage.setItem('rv:token', token);
        adminModal.hide(); setAdmin(true);
      } catch(err){ alert(err.message); }
    });
    $('#btn-logout').addEventListener('click', ()=>{ token=''; sessionStorage.removeItem('rv:token'); setAdmin(false); });

    // Export CSV
    $('#btn-export').addEventListener('click', ()=>{
      const rows = [['Nombre','Cédula','Teléfono','Municipio','Creado']].concat(
        state.items.map(v=>[v.nombre,v.cedula,v.telefono,v.municipio,v.created_at])
      );
      const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'votantes.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // Wipe local (solo aviso)
    $('#btn-wipe').addEventListener('click', ()=>{ alert('Esta acción, si la quieres real, la hacemos con un endpoint protegido en el backend.'); });

    // Init
    if (token) setAdmin(true);
    loadAndRender();
  </script>
</body>
</html>
